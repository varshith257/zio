"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[97775],{15680:(e,n,t)=>{t.d(n,{xA:()=>p,yg:()=>h});var a=t(96540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),d=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=d(e.components);return a.createElement(s.Provider,{value:n},e.children)},c="mdxType",g={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=d(t),m=r,h=c["".concat(s,".").concat(m)]||c[m]||g[m]||i;return t?a.createElement(h,o(o({ref:n},p),{},{components:t})):a.createElement(h,o({ref:n},p))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=m;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var d=2;d<i;d++)o[d]=t[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},52079:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>g,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var a=t(58168),r=(t(96540),t(15680));const i={id:"middleware",title:"Middleware"},o=void 0,l={unversionedId:"zio-http/reference/aop/middleware",id:"zio-http/reference/aop/middleware",title:"Middleware",description:"A middleware helps in addressing common crosscutting concerns without duplicating boilerplate code.",source:"@site/docs/zio-http/reference/aop/middleware.md",sourceDirName:"zio-http/reference/aop",slug:"/zio-http/reference/aop/middleware",permalink:"/zio-http/reference/aop/middleware",draft:!1,editUrl:"https://github.com/zio/zio/edit/series/2.x/docs/zio-http/reference/aop/middleware.md",tags:[],version:"current",frontMatter:{id:"middleware",title:"Middleware"},sidebar:"ecosystem-sidebar",previous:{title:"ProtocolStack",permalink:"/zio-http/reference/aop/protocol-stack"},next:{title:"HandlerAspect",permalink:"/zio-http/reference/aop/handler_aspect"}},s={},d=[{value:"Definition",id:"definition",level:2},{value:"Usage",id:"usage",level:2},{value:"Attaching Multiple Middlewares",id:"attaching-multiple-middlewares",level:2},{value:"Composing Middlewares",id:"composing-middlewares",level:2},{value:"Motivation",id:"motivation",level:2},{value:"The Problem: Violation of Separation of Concerns Principle",id:"the-problem-violation-of-separation-of-concerns-principle",level:3},{value:"The solution: Middleware and Aspect-oriented Programming",id:"the-solution-middleware-and-aspect-oriented-programming",level:3},{value:"The Solution: Middleware in ZIO-HTTP",id:"the-solution-middleware-in-zio-http",level:3},{value:"Building a Custom Middleware",id:"building-a-custom-middleware",level:2},{value:"Built-in Middlewares",id:"built-in-middlewares",level:2},{value:"Access Control Allow Origin (CORS) Middleware",id:"access-control-allow-origin-cors-middleware",level:3},{value:"Metrics Middleware",id:"metrics-middleware",level:3},{value:"Timeout Middleware",id:"timeout-middleware",level:3},{value:"Log Annotation Middleware",id:"log-annotation-middleware",level:3},{value:"Serving Static Files Middleware",id:"serving-static-files-middleware",level:3}],p={toc:d},c="wrapper";function g(e){let{components:n,...i}=e;return(0,r.yg)(c,(0,a.A)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"A middleware helps in addressing common crosscutting concerns without duplicating boilerplate code."),(0,r.yg)("h2",{id:"definition"},"Definition"),(0,r.yg)("p",null,"Middleware can be conceptualized as a functional component that accepts a ",(0,r.yg)("inlineCode",{parentName:"p"},"Routes")," and produces a new ",(0,r.yg)("inlineCode",{parentName:"p"},"Routes"),". The defined trait, ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware"),", is parameterized by a contravariant type ",(0,r.yg)("inlineCode",{parentName:"p"},"UpperEnv")," which denotes it can access the environment of the ",(0,r.yg)("inlineCode",{parentName:"p"},"Routes"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},"trait Middleware[-UpperEnv] { self =>\n  def apply[Env1 <: UpperEnv, Err](routes: Routes[Env1, Err]): Routes[Env1, Err]\n} \n")),(0,r.yg)("p",null,"This abstraction allows middleware to engage with the ",(0,r.yg)("inlineCode",{parentName:"p"},"Routes")," environment, and also the ability to tweak existing routes or add/remove routes as needed."),(0,r.yg)("p",null,"The diagram below illustrates how ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware")," works:"),(0,r.yg)("div",{style:{textAlign:"center",margin:"10px"}},(0,r.yg)("p",null,(0,r.yg)("img",{alt:"Middleware Diagram",src:t(54424).A}))),(0,r.yg)("h2",{id:"usage"},"Usage"),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},"@@")," operator attaches middleware to routes and HTTP applications.  The example below shows a middleware attached to an ",(0,r.yg)("inlineCode",{parentName:"p"},"Routes"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},'import zio.http._\n\nval app = Routes(\n  Method.GET / string("name") -> handler { (name: String, req: Request) => \n    Response.text(s"Hello $name")\n  }\n)\nval appWithMiddleware = app @@ Middleware.debug\n')),(0,r.yg)("p",null,"Logically the code above translates to ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware.debug(app)"),", which transforms the app using the middleware."),(0,r.yg)("h2",{id:"attaching-multiple-middlewares"},"Attaching Multiple Middlewares"),(0,r.yg)("p",null,"We can attach multiple middlewares by chaining them using more ",(0,r.yg)("inlineCode",{parentName:"p"},"@@")," operators:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},"val resultApp = routes @@ f1 @@ f2 @@ f3\n")),(0,r.yg)("p",null,"In the above code, when a new request comes in, it will first go through the ",(0,r.yg)("inlineCode",{parentName:"p"},"f3"),"'s incoming handler, then ",(0,r.yg)("inlineCode",{parentName:"p"},"f2"),", then ",(0,r.yg)("inlineCode",{parentName:"p"},"f1"),", and finally the ",(0,r.yg)("inlineCode",{parentName:"p"},"routes"),", when the response is going out, it will go through the ",(0,r.yg)("inlineCode",{parentName:"p"},"f1"),"'s outgoing handler, then ",(0,r.yg)("inlineCode",{parentName:"p"},"f2"),", then ",(0,r.yg)("inlineCode",{parentName:"p"},"f3"),", and finally will be sent out. So ",(0,r.yg)("strong",{parentName:"p"},"the order of the middlewares matters")," and if we change the order of the middlewares, the application's behavior may change."),(0,r.yg)("h2",{id:"composing-middlewares"},"Composing Middlewares"),(0,r.yg)("p",null,"Middleware can be combined using the ",(0,r.yg)("inlineCode",{parentName:"p"},"++")," operator:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},"routes @@ (f1 ++ f2 ++ f3)\n")),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},"f1 ++ f2 ++ f3")," applies from left to right with ",(0,r.yg)("inlineCode",{parentName:"p"},"f1")," first followed by others, like this:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},"f3(f2(f1(routes)))\n")),(0,r.yg)("h2",{id:"motivation"},"Motivation"),(0,r.yg)("p",null,"Before introducing middleware, let us understand why they are needed."),(0,r.yg)("h3",{id:"the-problem-violation-of-separation-of-concerns-principle"},"The Problem: Violation of Separation of Concerns Principle"),(0,r.yg)("p",null,"Consider the following example where we have two endpoints:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"GET /users/","{","id","}")," - Get a single user by id"),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"GET /users")," - Get all users")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},'val routes = Routes(\n  Method.GET / "users" / int("id") -> \n    handler { (id: Int, req: Request) =>\n      // core business logic  \n      dbService.lookupUsersById(id).map(Response.json(_.json))\n    },\n  Method.GET / "users" ->\n    handler {\n      // core business logic  \n      dbService.paginatedUsers(pageNum).map(Response.json(_.json))\n    }\n)\n')),(0,r.yg)("p",null,"As our application grows, we want to code the aspects like Basic Authentication, Request Logging, Response Logging, Timeout, and Retry for all our endpoints."),(0,r.yg)("p",null,"For both of our example endpoints, our core business logic gets buried under boilerplate like this:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},"(for {\n    // validate user\n    _    <- MyAuthService.doAuth(request)\n    // log request\n    _    <- logRequest(request)\n    // core business logic\n    user <- dbService.lookupUsersById(id).map(Response.json(_.json))\n    resp <- Response.json(user.toJson)\n    // log response\n    _    <- logResponse(resp)                \n} yield resp)\n        .timeout(2.seconds)\n        .retryN(5)\n")),(0,r.yg)("p",null,"Imagine repeating this for all our endpoints!"),(0,r.yg)("p",null,"So there are some problems with this approach:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Violation of Separation of Concerns Principle"),": Our current approach conflates business logic with cross-cutting concerns, such as timeouts, which violates the Separation of Concerns Principle. This coupling complicates the maintenance and understanding of our codebase."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Code Duplication"),": Replicating cross-cutting concerns across multiple routes results in unnecessary code duplication. For instance, if there are 100 routes, each requiring a timeout, we're forced to repeat the same logic 100 times. Consequently, any modification or upgrade to a shared concern, like altering the logging mechanism, necessitates making changes in numerous locations, significantly increasing the risk of errors and maintenance effort."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Maintenance Nightmare"),": With this approach, even a minor alteration in a cross-cutting concern demands updating every corresponding route. This not only escalates maintenance efforts but also complicates testing and debugging of core business logic. Consequently, the overall maintenance cost and complexity of the system are amplified."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Readability Issues"),"\u2014 This can lead to a lot of boilerplate clogging our neatly written endpoints affecting readability.")),(0,r.yg)("h3",{id:"the-solution-middleware-and-aspect-oriented-programming"},"The solution: Middleware and Aspect-oriented Programming"),(0,r.yg)("p",null,'If we refer to Wikipedia for the definition of an "',(0,r.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Aspect_(computer_programming)"},"Aspect"),'" we can glean the following points.'),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"An aspect of a program is a feature linked to many other parts of the program (",(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("em",{parentName:"strong"},"most common example, logging")),")."),(0,r.yg)("li",{parentName:"ul"},"Tt is not related to the program's primary function (",(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("em",{parentName:"strong"},"core business logic")),")."),(0,r.yg)("li",{parentName:"ul"},"An aspect crosscuts the program's core concerns (",(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("em",{parentName:"strong"},"for example logging code intertwined with core business logic")),")."),(0,r.yg)("li",{parentName:"ul"},'Therefore, it can violate the principle of "separation of concerns" which tries to encapsulate unrelated functions. (',(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("em",{parentName:"strong"},"Code duplication and maintenance nightmare")),")")),(0,r.yg)("p",null,"In short, aspect is a common concern required throughout the application, and its implementation could lead to repeated boilerplate code and violation of the principle of separation of concerns."),(0,r.yg)("p",null,"There is a paradigm in the programming world called ",(0,r.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Aspect-oriented_programming"},"aspect-oriented programming")," that aims for modular handling of these common concerns in an application."),(0,r.yg)("p",null,'Some examples of common "aspects" required throughout the application'),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Logging"),"\u2014 Essential for tracking system behavior and troubleshooting"),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Timeouts"),"\u2014 Used for preventing long-running code."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Retries"),"\u2014 Vital for handling flakiness, particularly when accessing third-party APIs."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Authentication"),"\u2014 Ensure users are authenticated before accessing REST resources, utilizing standard methods like basic authentication or more advanced approaches such as OAuth or single sign-on.")),(0,r.yg)("p",null,"This is where ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware")," comes to the rescue. Using middlewares we can compose out-of-the-box middlewares (or our custom middlewares) to address the above-mentioned concerns using ",(0,r.yg)("inlineCode",{parentName:"p"},"++")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"@@")," operators as shown below."),(0,r.yg)("h3",{id:"the-solution-middleware-in-zio-http"},"The Solution: Middleware in ZIO-HTTP"),(0,r.yg)("p",null,"We cleaned up the code using middleware to address cross-cutting concerns such as authentication, request/response logging, and more. See how we can handle multiple cross-cutting concerns by neatly composing middlewares in a single place:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},'import zio._\nimport zio.http._\n\n// compose basic auth, request/response logging, timeouts middlewares\nval composedMiddlewares = Middleware.basicAuth("user","pw") ++ \n        Middleware.debug ++ \n        Middleware.timeout(5.seconds) \n')),(0,r.yg)("p",null,"And then we can attach our composed bundle of middlewares to an Http using ",(0,r.yg)("inlineCode",{parentName:"p"},"@@")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},' val routes = Routes(\n  Method.GET / "users" / int("id") -> \n    handler { (id: Int, req: Request) =>\n      // core business logic  \n      dbService.lookupUsersById(id).map(Response.json(_.json))\n    },\n  Method.GET / "users" ->\n    handler {\n      // core business logic  \n      dbService.paginatedUsers(pageNum).map(Response.json(_.json))\n    }\n) @@ composedMiddlewares // attach composedMiddlewares to the routes using @@\n')),(0,r.yg)("p",null,"Observe how we gained the following benefits by using middlewares"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Readability"),": de-cluttering business logic."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Modularity"),": we can manage aspects independently without making changes in 100 places. For example, ",(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"replacing the logging mechanism from logback to log4j2 will require a change in one place, the logging middleware."),(0,r.yg)("li",{parentName:"ul"},"replacing the authentication mechanism from OAuth to single sign-on will require changing the auth middleware"))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Testability"),": we can test our aspects independently.")),(0,r.yg)("h2",{id:"building-a-custom-middleware"},"Building a Custom Middleware"),(0,r.yg)("p",null,"In most cases, we won't need a custom middleware. Instead, we have plenty of built-in middlewares that are ready to use. However, if we have a specific use case, we can create a custom middleware."),(0,r.yg)("p",null,"To build a custom middleware, we have to implement the ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware")," trait, which requires a single method ",(0,r.yg)("inlineCode",{parentName:"p"},"apply")," to be implemented. The ",(0,r.yg)("inlineCode",{parentName:"p"},"apply")," method accepts a ",(0,r.yg)("inlineCode",{parentName:"p"},"Routes")," and returns a new ",(0,r.yg)("inlineCode",{parentName:"p"},"Routes"),"."),(0,r.yg)("p",null,"For example, assume we want to replace every request path that starts with ",(0,r.yg)("inlineCode",{parentName:"p"},"/api")," with ",(0,r.yg)("inlineCode",{parentName:"p"},"/v1/api"),". We can create a custom middleware to achieve this:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},'val urlRewrite: Middleware[Any] =\n  new Middleware[Any] {\n    override def apply[Env1 <: Any, Err](routes: Routes[Env1, Err]): Routes[Env1, Err] =\n      routes.transform { handler =>\n        Handler.fromFunctionZIO { request =>\n          handler(\n            request.updateURL(url =>\n              if (url.path.startsWith(Path("/api")))\n                url.copy(path = Path("/v1") ++ url.path)\n              else url,\n            ),\n          )\n        }\n      }\n  }\n')),(0,r.yg)("p",null,"The above implementation is just for demonstration purposes. In practice, we can use the built-in ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware.updatePath")," to achieve the same functionality:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},'val urlRewrite: Middleware[Any] =\n  Middleware.updateURL(url =>\n    if (url.path.startsWith(Path("/api")))\n      url.copy(path = Path("/v1") ++ url.path)\n    else url,\n  )\n')),(0,r.yg)("h2",{id:"built-in-middlewares"},"Built-in Middlewares"),(0,r.yg)("p",null,"In this section we are going to introduce built-in middlewares that are provided by ZIO HTTP. Please note that the ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware")," object also inherits many other middlewares from the ",(0,r.yg)("inlineCode",{parentName:"p"},"HandlerAspect"),", that we will introduce them on the ",(0,r.yg)("a",{parentName:"p",href:"/zio-http/reference/aop/handler_aspect"},"HandlerAspect")," page."),(0,r.yg)("h3",{id:"access-control-allow-origin-cors-middleware"},"Access Control Allow Origin (CORS) Middleware"),(0,r.yg)("p",null,"The CORS middleware is used to enable cross-origin resource sharing. It allows the server to specify who can access the resources on the server. The origin is a combination of the protocol, domain, and port of the client. By default, the server does not allow cross-origin requests. What this means is that if a client is hosted on a different domain (or different protocol and port), the server will reject the request. So, if the client is hosted on ",(0,r.yg)("inlineCode",{parentName:"p"},"http://localhost:3000")," and the server is hosted on ",(0,r.yg)("inlineCode",{parentName:"p"},"http://localhost:8080"),", the server will reject the request."),(0,r.yg)("p",null,"This is where the client may want to create a preflight request to the server to ask for permission to access the resources. This is done by sending a preflight ",(0,r.yg)("inlineCode",{parentName:"p"},"OPTIONS")," request to the server with the headers ",(0,r.yg)("inlineCode",{parentName:"p"},"Origin"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"Access-Control-Request-Method"),", and ",(0,r.yg)("inlineCode",{parentName:"p"},"Access-Control-Request-Headers"),". If the server determines that the request is allowed, it includes an ",(0,r.yg)("inlineCode",{parentName:"p"},"Access-Control-Allow-Origin")," header in the response with a value that specifies which origins are permitted to access the resource. The same thing happens with the ",(0,r.yg)("inlineCode",{parentName:"p"},"Access-Control-Allow-Methods")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"Access-Control-Allow-Headers")," headers. Now the client can decide whether to send the actual request or not."),(0,r.yg)("p",null,"To create a CORS middleware, we can use the ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware.cors")," constructor. It takes a configuration object of type ",(0,r.yg)("inlineCode",{parentName:"p"},"CorsConfig")," that specifies the allowed origins, methods, headers, and so on. The ",(0,r.yg)("inlineCode",{parentName:"p"},"CorsConfig")," object has the following fields:"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"allowedOrigin")),"\u2014 A function that takes the origin of the client and returns allowed origins of type ",(0,r.yg)("inlineCode",{parentName:"li"},"Option[Header.AccessControlAllowOrigin]"),". By default, the configuration object allows all origins (",(0,r.yg)("inlineCode",{parentName:"li"},"*"),")."),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"allowedMethods")),"\u2014 The ",(0,r.yg)("inlineCode",{parentName:"li"},"Access-Control-Allow-Methods")," response header is used in response to a preflight request which includes the ",(0,r.yg)("inlineCode",{parentName:"li"},"Access-Control-Request-Method")," to indicate which HTTP methods can be used during the actual request. By default, the configuration object allows all methods (",(0,r.yg)("inlineCode",{parentName:"li"},"*"),")."),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"allowedHeaders")),"\u2014 The ",(0,r.yg)("inlineCode",{parentName:"li"},"Access-Control-Allow-Headers")," response header is used in response to a preflight request which includes the ",(0,r.yg)("inlineCode",{parentName:"li"},"Access-Control-Request-Headers")," to indicate which HTTP headers can be used during the actual request. By default, the configuration object allows all headers (",(0,r.yg)("inlineCode",{parentName:"li"},"*"),")."),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"allowCredentials")),"\u2014 The ",(0,r.yg)("inlineCode",{parentName:"li"},"Access-Control-Allow-Credentials")," header is sent in response to a preflight request which includes the ",(0,r.yg)("inlineCode",{parentName:"li"},"Access-Control-Request-Headers")," to indicate whether the actual request can be made using credentials. By default, this configuration is set to ",(0,r.yg)("inlineCode",{parentName:"li"},"Allow"),"."),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"exposedHeaders")),"\u2014 The ",(0,r.yg)("inlineCode",{parentName:"li"},"Access-Control-Expose-Headers")," header is used in response to a preflight request to indicate which headers can be exposed as part of the response. By default, the configuration object exposes all headers (",(0,r.yg)("inlineCode",{parentName:"li"},"*"),")."),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"maxAge")),"\u2014 The ",(0,r.yg)("inlineCode",{parentName:"li"},"Access-Control-Max-Age")," response header is used in response to a preflight request to indicate how long the results of a preflight request can be cached. By default, this configuration is set to ",(0,r.yg)("inlineCode",{parentName:"li"},"None"),".")),(0,r.yg)("p",null,"In the following example, we are going to serve two HTTP apps. The first app is a backend that serves a JSON response that contains a message. The second app is a frontend that serves an HTML page with a script that fetches the JSON response from the backend. The frontend is hosted on ",(0,r.yg)("inlineCode",{parentName:"p"},"http://localhost:3000")," and the backend is hosted on ",(0,r.yg)("inlineCode",{parentName:"p"},"http://localhost:8080"),". If we try to fetch the JSON response from the frontend, the server will reject the request because the client is hosted on a different origin."),(0,r.yg)("p",null,"To allow the frontend to access the backend, we need to create a CORS middleware that allows the origin ",(0,r.yg)("inlineCode",{parentName:"p"},"http://localhost:3001"),". We can do this by creating a ",(0,r.yg)("inlineCode",{parentName:"p"},"CorsConfig")," object with an ",(0,r.yg)("inlineCode",{parentName:"p"},"allowedOrigin")," function that returns ",(0,r.yg)("inlineCode",{parentName:"p"},"Some(AccessControlAllowOrigin.Specific(origin))")," if the origin is ",(0,r.yg)("inlineCode",{parentName:"p"},"http://localhost:3000"),". We then attach the CORS middleware to the backend using the ",(0,r.yg)("inlineCode",{parentName:"p"},"@@")," operator."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala",metastring:'title="zio-http-example/src/main/scala/example/HelloWorldWithCORS.scala"',title:'"zio-http-example/src/main/scala/example/HelloWorldWithCORS.scala"'},'package example\nimport zio._\n\nimport zio.http.Header.{AccessControlAllowOrigin, Origin}\nimport zio.http.Middleware.{CorsConfig, cors}\nimport zio.http._\nimport zio.http.codec.PathCodec\nimport zio.http.template._\n\nobject HelloWorldWithCORS extends ZIOAppDefault {\n\n  val config: CorsConfig =\n    CorsConfig(\n      allowedOrigin = {\n        case origin if origin == Origin.parse("http://localhost:3000").toOption.get =>\n          Some(AccessControlAllowOrigin.Specific(origin))\n        case _                                                                      => None\n      },\n    )\n\n  val backend: Routes[Any, Response] =\n    Routes(\n      Method.GET / "json" -> handler(Response.json("""{"message": "Hello World!"}""")),\n    ) @@ cors(config)\n\n  val frontend: Routes[Any, Response] =\n    Routes(\n      Method.GET / PathCodec.empty -> handler(\n        Response.html(\n          html(\n            p("Message: ", output()),\n            script("""\n                     |// This runs on http://localhost:3000\n                     |fetch("http://localhost:8080/json")\n                     |  .then((res) => res.json())\n                     |  .then((res) => document.querySelector("output").textContent = res.message);\n                     |""".stripMargin),\n          ),\n        ),\n      ),\n    )\n\n  val frontEndServer = Server.serve(frontend).provide(Server.defaultWithPort(3000))\n  val backendServer  = Server.serve(backend).provide(Server.defaultWithPort(8080))\n\n  val run = frontEndServer.zipPar(backendServer)\n}\n')),(0,r.yg)("h3",{id:"metrics-middleware"},"Metrics Middleware"),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware.metrics")," middleware is used to collect metrics about the HTTP requests and responses that are processed by the server. The middleware collects the following metrics:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"http_requests_total")),"\u2014 The total number of HTTP requests that have been processed by the server, using the counter metric type."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"http_request_duration_seconds")),"\u2014 The duration of the HTTP requests in seconds, using the histogram metric type."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"http_concurrent_requests_total")),"\u2014 The total number of concurrent HTTP requests that are being processed by the server, using the gauge metric type.")),(0,r.yg)("p",null,"In the following example, we are going to serve two HTTP apps. One app is a backend that has some routes and the other app is a metrics app that serves the Prometheus metrics. We have attached the ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware.metrics")," middleware to the backend using the ",(0,r.yg)("inlineCode",{parentName:"p"},"@@")," operator."),(0,r.yg)("p",null,"In this example we used the Prometheus connector, so we need to add the following dependencies to the ",(0,r.yg)("inlineCode",{parentName:"p"},"build.sbt")," file:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},'libraryDependencies ++= Seq(\n  "dev.zio" %% "zio-metrics-connectors"            % "2.3.1",\n  "dev.zio" %% "zio-metrics-connectors-prometheus" % "2.3.1"\n)\n')),(0,r.yg)("p",null,"To integrate with other metrics systems, please refer to the ",(0,r.yg)("a",{parentName:"p",href:"https://zio.dev/zio-metrics-connectors/"},"ZIO Metrics Connectors")," documentation."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala",metastring:'title="zio-http-example/src/main/scala/example/HelloWorldWithMetrics.scala"',title:'"zio-http-example/src/main/scala/example/HelloWorldWithMetrics.scala"'},'package example\n\nimport zio._\nimport zio.metrics._\nimport zio.metrics.connectors.prometheus.PrometheusPublisher\nimport zio.metrics.connectors.{MetricsConfig, prometheus}\n\nimport zio.http._\n\nobject HelloWorldWithMetrics extends ZIOAppDefault {\n\n  val backend: Routes[Any, Response] =\n    Routes(\n      Method.GET / "json"      -> handler((req: Request) =>\n        ZIO.succeed(Response.json("""{"message": "Hello World!"}""")) @@ Metric\n          .counter("x_custom_header_total")\n          .contramap[Any](_ => if (req.headers.contains("X-Custom-Header")) 1L else 0L),\n      ),\n      Method.GET / "forbidden" -> handler(ZIO.succeed(Response.forbidden)),\n    ) @@ Middleware.metrics()\n\n  val metrics: Routes[PrometheusPublisher, Response] =\n    Routes(\n      Method.GET / "metrics" -> handler(ZIO.serviceWithZIO[PrometheusPublisher](_.get.map(Response.text))),\n    )\n\n  val run =\n    Server\n      .serve(backend ++ metrics)\n      .provide(\n        Server.default,\n        // The prometheus reporting layer\n        prometheus.prometheusLayer,\n        prometheus.publisherLayer,\n        // Interval for polling metrics\n        ZLayer.succeed(MetricsConfig(1.seconds)),\n      )\n}\n')),(0,r.yg)("p",null,"Another important thing to note is that the ",(0,r.yg)("inlineCode",{parentName:"p"},"metrics")," middleware only attaches to the ",(0,r.yg)("inlineCode",{parentName:"p"},"Routes")," or ",(0,r.yg)("inlineCode",{parentName:"p"},"Routes"),", so if we want to track some custom metrics particular to a handler, we can use the ",(0,r.yg)("inlineCode",{parentName:"p"},"ZIO#@@")," operator to attach a metric of type ",(0,r.yg)("inlineCode",{parentName:"p"},"ZIOAspect")," to the ZIO effect that is returned by the handler. For example, if we want to track the number of requests that have a custom header ",(0,r.yg)("inlineCode",{parentName:"p"},"X-Custom-Header")," in the ",(0,r.yg)("inlineCode",{parentName:"p"},"/json")," route, we can attach a counter metric to the ZIO effect that is returned by the handler using the ",(0,r.yg)("inlineCode",{parentName:"p"},"@@")," operator."),(0,r.yg)("h3",{id:"timeout-middleware"},"Timeout Middleware"),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware.timeout")," middleware is used to set a timeout for the HTTP requests that are processed by the server. If the request takes longer than the specified duration, the server will respond with request timeout status code ",(0,r.yg)("inlineCode",{parentName:"p"},"408"),". The middleware takes a ",(0,r.yg)("inlineCode",{parentName:"p"},"Duration")," parameter that specifies the timeout duration."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},"routes @@ Middleware.timeout(5.seconds)\n")),(0,r.yg)("h3",{id:"log-annotation-middleware"},"Log Annotation Middleware"),(0,r.yg)("p",null,"Using the ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware.logAnnotate*")," middleware, we can add more annotations to the logging context. There are several variations of the ",(0,r.yg)("inlineCode",{parentName:"p"},"logAnnotate")," middleware:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"logAnnotate(key: => String, value: => String)")),"\u2014 Adds a single log annotation with the specified key and value."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"logAnnotate(logAnnotation: => LogAnnotation, logAnnotations: => LogAnnotation*)")),"\u2014 Adds multiple log annotations with the specified log annotations."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"logAnnotate(logAnnotations: => Set[LogAnnotation])")),"\u2014 Adds multiple log annotations with the specified set of log annotations."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"logAnnotate(fromRequest: Request => Set[LogAnnotation])")),"\u2014 Adds log annotations derived from the request."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"logAnnotateHeaders(headerName: String, headerNames: String*)")),"\u2014 Adds log annotations with the names and values of the specified headers."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"logAnnotateHeaders(header: Header.HeaderType, headers: Header.HeaderType*)")),"\u2014 Adds log annotations with the names and values of the specified headers.")),(0,r.yg)("p",null,"Let's write a middleware that adds a correlation ID to the logging context, which is derived from the ",(0,r.yg)("inlineCode",{parentName:"p"},"X-Correlation-ID")," header of the request. If the header is not present, we generate a random UUID as the correlation ID:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},'val correlationId =\n  Middleware.logAnnotate{ req =>\n    val correlationId =\n      req.headers.get("X-Correlation-ID").getOrElse(\n        Unsafe.unsafe { implicit unsafe =>\n          Runtime.default.unsafe.run(Random.nextUUID.map(_.toString)).getOrThrow()\n        }\n      )\n\n    Set(LogAnnotation("correlation-id", correlationId))\n  }\n')),(0,r.yg)("p",null,"To see the correlation ID in the logs, we need to place the middleware after the request logging middleware:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala"},"routes @@ Middleware.requestLogging() @@ correlationId\n")),(0,r.yg)("p",null,"Now, if we call one of the routes with the ",(0,r.yg)("inlineCode",{parentName:"p"},"X-Correlation-ID")," header, we should see the correlation ID in the logs:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-shell"},'timestamp=2024-04-12T08:16:26.034894Z level=INFO thread=#zio-fiber-44 message="Http request served" location=example.HelloWorldWithLogging.backend file=HelloWorldWithLogging.scala line=20 method=GET correlation-id=34fab1bb-eeca-4b4f-975d-12f18e94f2e7 duration_ms=77 url=/json response_size=27 status_code=200 request_size=0\n')),(0,r.yg)("h3",{id:"serving-static-files-middleware"},"Serving Static Files Middleware"),(0,r.yg)("p",null,"With the ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware.serveDirectory")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"Middleware.serveResources")," middlewares, we can serve static files from a directory or resource directory in the classpath:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-scala",metastring:'title="zio-http-example/src/main/scala/example/StaticFiles.scala"',title:'"zio-http-example/src/main/scala/example/StaticFiles.scala"'},'package example\n\nimport zio._\n\nimport zio.http._\n\nobject StaticFiles extends ZIOAppDefault {\n\n  /**\n   * Creates an HTTP app that only serves static files from resources via\n   * "/static". For paths other than the resources directory, see\n   * [[zio.http.Middleware.serveDirectory]].\n   */\n  val routes = Routes.empty @@ Middleware.serveResources(Path.empty / "static")\n\n  override def run = Server.serve(routes).provide(Server.default)\n}\n')))}g.isMDXComponent=!0},54424:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/middleware-33b3e3adba845f2eee858b7d8f57ee89.svg"}}]);